{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
<div class="container mt-4 mb-5">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-9">

            <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                {% csrf_token %}

                <div class="card shadow-sm mb-3 sticky-top" style="top: 10px; z-index: 1000;">
                        <div class="card-body d-flex justify-content-between align-items-center py-2">
                            <div>
                                <h5 class="mb-0 fs-6">Editando: Ficha de Identificação</h5>
                                <small class="text-muted d-block d-md-inline">
                                    Selecione a foto 3x4 e se for autônomo ou empregado para editar.
                                </small>
                            </div>
                            <div>
                                <a href="{% url 'visualizar_documento_estagio' documento.id %}" class="btn btn-secondary btn-sm">Cancelar</a>
                                <button type="submit" class="btn btn-primary btn-sm px-3">Salvar</button> 
                            </div>
                        </div>
                        {% if form.errors or form.non_field_errors %}
                            <div class="card-footer bg-danger-subtle text-danger py-2 px-3">
                                <strong class="d-block mb-1">Erro ao salvar: Por favor, corrija os campos abaixo.</strong>
                                <ul class="mb-0 ps-4" style="font-size: 0.9em;">
                                    {% for error in form.non_field_errors %}
                                        <li>{{ error }}</li>
                                    {% endfor %}
                                    
                                    {% for field in form %}
                                        {% for error in field.errors %}
                                            <li>
                                                <strong>{{ field.label }}:</strong> {{ error }}
                                            </li>
                                        {% endfor %}
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}
                    </div>

                    <div class="card shadow-sm">
                        <div class="card-body p-4 p-md-5 document-body">

    <div class="text-center mb-4">
        <img src="{% static 'assets/img/cabecalho.png' %}" alt="Cabeçalho CEEP" style="width: 100%;">
    </div>

    <div class="row align-items-center mb-4">
        
        <div class="col-9 text-center">
            <h4 style="margin:0; font-size:14px"><strong>CENTRO ESTADUAL DE EDUCAÇÃO PROFISSIONAL</strong></h4>
            <h4 style="margin:0; font-size:14px"><strong>EM SAÚDE E GESTÃO – GUANAMBI/BA</strong></h4>
            <p style="margin:0; font-size:14px;">Formando cidadãos para o mundo do trabalho!</p>
            
            <h5 class="mt-3 fw-bold">FICHA DO ALUNO(A)</h5>
            <h5 class="text-center fw-bold mb-4" style="text-transform: uppercase; margin-top:40px; font-size:18px;">
                CURSO: TÉCNICO EM {{ aluno.alunoturma_set.first.turma.curso.nome }}
            </h5>
        </div>

        <div class="col-3 d-flex flex-column align-items-center justify-content-center">
            
            <div class="mb-2" style="
                width: 140px; 
                height: 200px; 
                border: 3px solid #0b498bff; 
                margin-top: -30px; 
                display: flex; 
                align-items: center; 
                justify-content: center; 
                background-color: #fff; 
                overflow: hidden;">
                
                {% if documento.foto_3x4 %}
                    <img src="{{ documento.foto_3x4.url }}" style="width: 100%; height: 100%; object-fit: cover;">
                {% else %}
                    <span style="font-size: 12px; color: #000;">FOTO 3x4</span>
                {% endif %}
            </div>

            <div style="width: 140px;"> {{ form.foto_3x4|add_class:"form-control form-control-sm" }}
                {% if form.foto_3x4.errors %}
                    <div class="text-danger small">{{ form.foto_3x4.errors }}</div>
                {% endif %}
            </div>

        </div>

    </div>

                            <div class="row">
                                <div class="col-9">
                                    <h6 class="fw-bold text-uppercase mb-3" style='font-size:18px;'>Identificação:</h6>

                                    <div class="mb-1">
                                        Nome: {{ aluno.get_full_name|default:"(Nome Completo)" }}
                                        <span class="ms-3">Série: {{ aluno.alunoturma_set.first.turma.ano_modulo|default:"(Série)" }}</span>
                                        <span class="ms-3">Turma: {{ aluno.alunoturma_set.first.turma.turma|default:"(Turma)" }}</span>
                                    </div>

                                    <div class="mb-1">
                                        Turno: {{ aluno.alunoturma_set.first.turma.get_turno_display|default:"(Turno)" }}
                                        <span class="ms-4">Modalidade: {{ aluno.alunoturma_set.first.turma.modalidade|default:"(Modalidade)" }}</span>
                                    </div>

                                    <div class="mb-1">
                                        Cidade de Nascimento: {{ aluno.cidade_nascimento|default:"(Cidade/Estado)" }}
                                    </div>

                                    <div class="mb-1">
                                        Data de nascimento: {{ aluno.data_nascimento|date:"d/m/Y"|default:"--/--/----" }}
                                    </div>

                                    {% with rg=aluno.rg %}
                                    <div class="mb-1">
                                        RG:
                                        {% if rg %}
                                            {{ rg|slice:":2" }}.{{ rg|slice:"2:5" }}.{{ rg|slice:"5:8" }}-{{ rg|slice:"8:" }}
                                        {% else %}
                                            ---
                                        {% endif %}
                                        <span class="ms-3">Órgão: {{ aluno.orgao|default:"SSP-BA" }}</span>
                                    </div>
                                    {% endwith %}

                                    <div class="mb-1">
                                        Data de expedição: {{ aluno.data_expedicao|date:"d/m/Y"|default:"--/--/----" }}
                                    </div>

                                    {% with cpf=aluno.cpf %}
                                    <div class="mb-1">
                                        CPF:
                                        {% if cpf %}
                                            {{ cpf|slice:":3" }}.{{ cpf|slice:"3:6" }}.{{ cpf|slice:"6:9" }}-{{ cpf|slice:"9:" }}
                                        {% else %}
                                            ---
                                        {% endif %}
                                    </div>
                                    {% endwith %}

                                    <div class="mb-3">
                                        Nº de matrícula: {{ aluno.numero_matricula|default:"(Matrícula)" }}
                                    </div>

                                    <div class="mb-1">Pai: {{ aluno.nome_pai|default:"(Nome do Pai)" }}</div>
                                    <div class="mb-1">Mãe: {{ aluno.nome_mae|default:"(Nome da Mãe)" }}</div>
                                    <div class="mb-1">Responsável pela matrícula: {{ aluno.responsavel_matricula|default:"(Responsável)" }}</div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <h6 class="fw-bold text-uppercase" style='font-size:18px;'>Endereço:</h6>
                                <div class="mb-1">
                                    {{ aluno.endereco_rua|default:"(Rua)" }} n° {{ aluno.endereco_numero|default:"(N°)" }}
                                </div>
                                <div class="mb-1">
                                    Bairro: {{ aluno.endereco_bairro|default:"(Bairro)" }}
                                    <span class="ms-3">Cidade: {{ aluno.endereco_cidade|default:"(Cidade)" }}</span>
                                    <span class="ms-3">CEP: {{ aluno.endereco_cep|default:"(CEP)" }}</span>
                                </div>
                                <div class="mb-1">
                                    Fone: {{ aluno.telefone|default:"(Telefone)" }}
                                </div>
                            </div>

                            <div class="mt-4 p-3 bg-light border rounded">
                                <h6 class="fw-bold text-uppercase text-primary mb-3" style='font-size:18px;'>
                                    <i class="fas fa-pen me-2"></i>Atividade Extra-Escola:
                                </h6>
                                
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Você possui vínculo empregatício?</label>
                                    <div class="d-flex gap-4">
                                        {% for radio in form.atividade_tipo %}
                                            <div class="form-check">
                                                {{ radio.tag }}
                                                <label class="form-check-label" for="{{ radio.id_for_label }}">
                                                    {{ radio.choice_label }}
                                                </label>
                                            </div>
                                        {% endfor %}
                                    </div>
                                    {% if form.atividade_tipo.errors %}
                                        <div class="text-danger small">{{ form.atividade_tipo.errors }}</div>
                                    {% endif %}
                                </div>

                                <div id="grupo-empresa">
                                    <hr>
                                    <div class="row g-3">
                                        <div class="col-md-8">
                                            <label class="form-label fw-bold small">Nome da Empresa:</label>
                                            {{ form.atividade_empresa|add_class:"form-control form-control-sm" }}
                                            {% if form.atividade_empresa.errors %} <div class="text-danger small">{{ form.atividade_empresa.errors }}</div> {% endif %}
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold small">Carga Horária:</label>
                                            {{ form.atividade_carga_horaria|add_class:"form-control form-control-sm" }}
                                            {% if form.atividade_carga_horaria.errors %} <div class="text-danger small">{{ form.atividade_carga_horaria.errors }}</div> {% endif %}
                                        </div>
                                        
                                        <div class="col-md-12">
                                            <label class="form-label fw-bold small">Função:</label>
                                            {{ form.atividade_funcao|add_class:"form-control form-control-sm" }}
                                            {% if form.atividade_funcao.errors %} <div class="text-danger small">{{ form.atividade_funcao.errors }}</div> {% endif %}
                                        </div>

                                        <h6 class="fw-bold mt-3 mb-0 small text-uppercase">Endereço da Empresa:</h6>
                                        
                                        <div class="col-md-10">
                                            <label class="form-label small">Rua/Av./Pça:</label>
                                            {{ form.atividade_rua|add_class:"form-control form-control-sm" }}
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label small">Número:</label>
                                            {{ form.atividade_numero|add_class:"form-control form-control-sm" }}
                                        </div>
                                        
                                        <div class="col-md-5">
                                            <label class="form-label small">Bairro:</label>
                                            {{ form.atividade_bairro|add_class:"form-control form-control-sm" }}
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small">Cidade:</label>
                                            {{ form.atividade_cidade|add_class:"form-control form-control-sm" }}
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label small">CEP:</label>
                                            {{ form.atividade_cep|add_class:"form-control form-control-sm" }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4">
                                <h6 class="fw-bold text-uppercase">Observação:</h6>
                                <div style="border-bottom: 1px solid #000; min-height: 25px; margin-bottom: 5px; background-color: #f9f9f9;">
                                    <small class="text-muted ps-2">Espaço reservado para observações da secretaria/coordenação.</small>
                                </div>
                                <div style="border-bottom: 1px solid #000; min-height: 25px; margin-bottom: 5px;"></div>
                                <div style="border-bottom: 1px solid #000; min-height: 25px; margin-bottom: 5px;"></div>
                            </div>

                            <p class="mt-5 mb-4 text-end">Guanambi, _______ de __________ de ________</p>

                            <div class="mt-5 text-center" style="font-size: 12pt; font-family: sans-serif;">
                                <p class="mb-0 fw-bold fst-italic">
                                    Av. Santos Dumont, s/n Centro – Guanambi/BA
                                </p>
                                <p class="mb-0 fw-bold fst-italic">
                                    77-3451-5096/3451-5444 (Telefone fixo e WhatsApp)
                                </p>
                                <p class="mb-0 fw-bold fst-italic">
                                    ceep.saudeegestao@educacao.ba.gov.br
                                </p>
                                <p class="mb-0 fw-bold fst-italic">
                                    https://www.ceep-guanambi.com
                                </p>
                            </div>
                        </div> </div>
            </form>
        </div>
    </div>
</div>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const radioNenhuma = document.querySelector('input[value="NENHUMA"]');
    const radioAutonomo = document.querySelector('input[value="AUTONOMO"]');
    const radioEmpregado = document.querySelector('input[value="EMPREGADO"]');
    const grupoEmpresa = document.getElementById('grupo-empresa');
    
    // Seleciona todos os inputs dentro do grupo da empresa para poder habilitar/desabilitar
    const inputsEmpresa = grupoEmpresa.querySelectorAll('input');

    function toggleEmpresaFields() {
        if (radioNenhuma.checked) {
            grupoEmpresa.style.display = 'none';
            // Limpa e desabilita campos se for "Nenhuma"
            inputsEmpresa.forEach(input => {
                input.disabled = true;
                input.value = ''; 
            });
        } else {
            grupoEmpresa.style.display = 'block';
            // Habilita campos
            inputsEmpresa.forEach(input => {
                input.disabled = false;
            });
        }
    }

    // Adiciona evento de mudança nos radios
    const radios = document.querySelectorAll('input[name="atividade_tipo"]');
    radios.forEach(radio => {
        radio.addEventListener('change', toggleEmpresaFields);
    });

    // Executa ao carregar a página para definir o estado inicial
    toggleEmpresaFields();
});
</script>
{% endblock %}

{% endblock content %}